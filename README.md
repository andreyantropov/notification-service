# isplanar-notification

## Описание

Сервис предназначен для автоматической отправки уведомлений ISPlanar пользователям через различные каналы связи: Bitrix, email и т.д. Он проверяет наличие уведомлений в базе данных, отправляет их выбранным способом (в зависимости от доступных контактных данных пользователя) и удаляет из очереди после успешной отправки.

---

## Запуск сервиса

Сервис рекомендуется запускать с помощью crontab с учетом следующих ограничений:

- Не чаще 1 раза в 10 секунд
- Не реже 1 раза в 10 минут

Пример настройки crontab для запуска каждые 10 секунд:

````bash
* * * * * for i in 0 10 20 30 40 50; do /path/to/your/command && sleep 10; done

---

## Архитектура сервиса

Сервис построен с использованием функционального подхода и разделён на следующие слои:

1. **Слой доступа к данным**:

   - Отвечает за взаимодействие с базой данных: чтение списка уведомлений и удаление отправленных уведомлений.

2. **Слой отправки уведомлений**:

   - Содержит функции для отправки уведомлений через разные каналы: Bitrix, email и Telegram.
   - Выбор канала осуществляется на основе контактных данных пользователя.

3. **Слой логирования**:

   - Предоставляет методы для регистрации событий и ошибок в процессе работы сервиса.

4. **Слой бизнес-логики**:
   - Управляет основным процессом: получение уведомлений, отправка их через соответствующие каналы, удаление из очереди и логирование результатов.

---

## Установка и запуск

### Требования

1. Node.js версии 16 или выше.
2. Доступ к базе данных Firebird (настроена интеграция через `firebird`).
3. Настроенные параметры для отправки уведомлений через Bitrix, email и Telegram.

### Установка зависимостей

```bash
npm install
````

### Настройка окружения

Создайте файл `.env` в корневой директории проекта и укажите необходимые переменные окружения:

```env
# Параметры подключения к базе данных Firebird
FIREBIRD_HOST=localhost
FIREBIRD_PORT=3050
FIREBIRD_DATABASE=path/to/your/database.fdb
FIREBIRD_USER=sysdba
FIREBIRD_PASSWORD=masterkey

# Параметры для отправки уведомлений
BITRIX_API_URL=https://your-bitrix-domain.com/rest/
BITRIX_API_TOKEN=your-bitrix-api-token

EMAIL_SMTP_HOST=smtp.your-email-provider.com
EMAIL_SMTP_PORT=587
EMAIL_SMTP_USER=your-email@example.com
EMAIL_SMTP_PASSWORD=your-email-password

#Параметры окружения
CURRENT_SERVICE=isplanar-notification
CALLER_SERVICE=crontab
TRIGGER_TYPE=cron
```

### Запуск сервиса

Запустите сервис с помощью команды:

```bash
npm start
```

или напрямую через Node.js:

```bash
node index.js
```

---

## Логика работы

1. **Чтение уведомлений**:

   - Сервис считывает список уведомлений из базы данных Firebird.
   - Каждое уведомление содержит:
     - ID уведомления.
     - Контактные данные пользователя (Bitrix, email или Telegram).
     - Текст сообщения.

2. **Отправка уведомлений**:

   - Для каждого уведомления выбирается канал отправки на основе контактных данных пользователя:
     - Если указан Bitrix, уведомление отправляется через API Bitrix.
     - Если указан email, уведомление отправляется через SMTP.
     - Если указан Telegram, уведомление отправляется через Telegram Bot API.
   - В случае отсутствия подходящих контактных данных выбрасывается ошибка.

3. **Удаление уведомлений**:

   - После успешной отправки уведомление удаляется из очереди в базе данных.

4. **Логирование**:
   - Все события (успешная отправка, ошибки) регистрируются в консоли.

---

## Расширение функционала

1. **Добавление нового канала отправки**:

   - Создайте новую функцию для отправки уведомлений через новый канал.
   - Интегрируйте её в функцию `sendNotification`.

2. **Изменение логики выбора канала**:

   - Модифицируйте функцию `sendNotification`, чтобы добавить новые условия выбора канала.

3. **Добавление логирования в файл**:
   - Расширьте функцию `logNotification`, чтобы записывать события в файл.

---
