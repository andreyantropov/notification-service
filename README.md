# isplanar-notification

## Описание

Сервис автоматической рассылки уведомлений пользователям ISPlanar через различные каналы связи:

- Bitrix24
- Email

Сервис проверяет очередь уведомлений в базе данных Firebird, определяет оптимальный канал доставки на основе доступных контактных данных пользователя, отправляет уведомления и удаляет успешно отправленные записи из очереди.

---

## Системные требования

Для корректной работы сервиса необходимы:

1. **Node.js**: v23.x или выше
2. **npm**: v10.x или выше
3. **СУБД Firebird**: v2.5/v3.x с настроенным доступом
4. **SMTP-сервер** для отправки email-уведомлений
5. **Bitrix24 REST API**: активный портал с настроенным webhook
6. **InfluxDB** для централизованного логирования (опционально)

---

## Переменные окружения (.env)

Создайте файл `.env` в корневой директории проекта со следующими параметрами:

### База данных Firebird

FIREBIRD_HOST=localhost # Хост базы данных
FIREBIRD_PORT=3050 # Порт подключения
FIREBIRD_DATABASE=/path/to/db.fdb # Путь к файлу базы данных
FIREBIRD_USER=sysdba # Имя пользователя
FIREBIRD_PASSWORD=masterkey # Пароль

### Настройки Bitrix24

BITRIX_API_URL=https://your-domain.bitrix24.ru/rest/ # URL API Bitrix
BITRIX_API_TOKEN=your_token_here # Webhook токен

### Настройки Email

EMAIL_SMTP_HOST=smtp.your-email.com # SMTP сервер
EMAIL_SMTP_PORT=587 # Порт SMTP
EMAIL_SMTP_USER=your-email@gmail.com # Email адрес отправителя
EMAIL_SMTP_PASSWORD=your_password # Пароль от почты

### Логирование (опционально)

INFLUXDB_URL=https://influxdb.example.com # URL InfluxDB
INFLUXDB_TOKEN=your_influxdb_token # Токен доступа
INFLUXDB_ORG=YourOrganization # Организация
INFLUXDB_BUCKET=notifications # Bucket для хранения логов

### Метаданные сервиса

CURRENT_SERVICE=isplanar-notification # Имя текущего сервиса
CALLER_SERVICE=crontab # Вызывающий сервис (по умолчанию: unknown-service)
TRIGGER_TYPE=cron # Тип триггера (по умолчанию: manual)

---

## Установка и запуск

### 1. Установка зависимостей

```bash
npm install
```

### 2. Доступные команды (package.json scripts)

| Команда          | Описание                                                            |
| ---------------- | ------------------------------------------------------------------- |
| `npm run build`  | Компиляция TypeScript кода в JavaScript (результат в папке `dist`)  |
| `npm run start`  | Запуск скомпилированного приложения в production режиме             |
| `npm run dev`    | Запуск приложения в режиме разработки с автоматическим перезапуском |
| `npm run prod`   | Полный цикл: компиляция + запуск в production режиме                |
| `npm run lint`   | Проверка кода на соответствие правилам ESLint                       |
| `npm run fix`    | Автоматическое исправление простых ошибок форматирования            |
| `npm run format` | Форматирование кода с помощью Prettier                              |
| `npm run test`   | Запуск юнит-тестов                                                  |

### 3. Примеры использования

#### Режим разработки

```bash
npm run dev
```

Автоматически следит за изменениями в файлах `.ts` и перезапускает сервер.

#### Production сборка

```bash
npm run prod
```

Выполняет компиляцию TypeScript в JavaScript и запускает приложение.

#### Запуск тестов

```bash
npm run test
```

Запускает все юнит-тесты с использованием Jest.

---

## Логика работы

1. **Чтение уведомлений**

   - Подключение к базе данных Firebird
   - Получение списка активных уведомлений
   - Каждое уведомление содержит:
     - ID
     - Контактные данные получателя
     - Текст сообщения
     - Приоритет канала доставки

2. **Отправка уведомлений**

   - Определение канала доставки по наличию контактных данных
   - Попытка отправки через выбранный канал
   - В случае неудачи пробует альтернативные каналы

3. **Обработка результатов**
   - Успешно отправленные уведомления удаляются из очереди
   - Ошибки регистрируются в логах
   - Статистика отправки записывается в InfluxDB (если настроено)

---

## Cron настройка

Рекомендуемый интервал запуска:

- не чаще, чем раз в секунду;
- не реже, чем раз в 10 минут.

Пример конфигурации crontab:

```bash
* * * * * for i in 0 10 20 30 40 50; do /path/to/your/command && sleep 10; done
```
