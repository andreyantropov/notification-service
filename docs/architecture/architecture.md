# Архитектура проекта

## Компоненты

1. **Сервис уведомлений (INS)**

   - Описание: Сервис автоматической рассылки уведомлений пользователям ISPlanar через различные каналы связи (Bitrix24, Email). Получает список уведомлений напрямую из базы данных Firebird и поддерживает централизованное логирование в InfluxDB.
   - Технологии: TypeScript + Node.js.
   - Зависимости:
     - Библиотеки: `axios`, `node-firebird`, `@influxdata/influxdb-client`, `dotenv`.
     - Инструменты разработки: `eslint`, `prettier`, `jest`, `ts-node`, `nodemon`.

2. **База данных Firebird**

   - Описание: Хранит данные о неподтвержденных уведомлениях, которые необходимо обработать. Также используется для хранения других данных системы ISPlanar.
   - Версия: Firebird 2.5.9.
   - Драйвер: `node-firebird`.

3. **Централизованное логирование (Log)**

   - Описание: Система сбора и хранения логов для мониторинга работы сервиса.
   - Технологии: InfluxDB.
   - Клиентская библиотека: `@influxdata/influxdb-client`.

4. **Каналы отправки уведомлений**
   - **Bitrix24**: Первичный канал отправки уведомлений через API Bitrix24.
     - Библиотека: `axios`.
   - **SMTP**: Резервный канал отправки уведомлений через почтовый сервер.
     - Библиотека `nodemailer`.

---

## Диаграмма компонентов

```mermaid
flowchart TB
    subgraph Docker
        Container[Контейнер isplanar-notification]
    end

    ISPlanar --> Firebird[(Firebird DB)]
    Scheduler --> Container
    Container --> Firebird
    Container --> Bitrix[(Bitrix24 API)]
    Container --> SMTP[(SMTP сервер)]
    Container --> Log[(InfluxDB)]
    Log --> Admin
    Bitrix --> User
    SMTP --> User
```

---

## Диаграмма последовательностей

```mermaid
sequenceDiagram
    participant Scheduler as Планировщик
    participant INS as Сервис уведомлений
    participant Firebird as База данных Firebird
    participant Bitrix as Bitrix24 API
    participant SMTP as SMTP сервер
    participant Log as Логирование

    loop Каждые 1-60 секунд
        Scheduler->>INS: Триггер обработки
        INS->>Firebird: Запрос на список уведомлений

        alt Есть уведомления
            Firebird-->>INS: Список уведомлений

            loop Для каждого уведомления
                loop 3 попытки (Bitrix)
                    INS->>Bitrix: Отправка уведомления

                    alt Успех
                        Bitrix-->>INS: 200 OK
                        INS->>Log: INFO "Успешная отправка через Bitrix"
                        break
                    else Ошибка
                        Bitrix-->>INS: 400 Error
                    end
                end

                alt Bitrix не ответил за 3 попытки
                    loop 3 попытки (SMTP)
                        INS->>SMTP: Отправка уведомления

                        alt Успех
                            SMTP-->>INS: 200 OK
                            INS->>Log: INFO "Успешная отправка через SMTP"
                            break
                        else Ошибка
                            SMTP-->>INS: 400 Error
                        end
                    end

                    alt SMTP тоже не ответил
                        INS->>Log: ERROR "Не удалось отправить уведомление"
                    end
                end

                INS->>Firebird: Удаление уведомления
                Firebird-->>INS: Подтверждение удаления
            end
        else Нет уведомлений
            Firebird-->>INS: Пустой список
        end
    end
```

---

## Описание процесса работы системы

1. **Планировщик запускает обработку**:

   - Планировщик (Scheduler) отправляет триггер на запуск обработки каждые 1–60 секунд.

2. **Запрос списка уведомлений**:

   - Сервис уведомлений (INS) выполняет SQL-запрос к базе данных Firebird для получения списка неподтвержденных уведомлений.

3. **Обработка уведомлений**:

   - Если уведомления есть, INS пытается отправить их через Bitrix24 API.
   - При неудачной отправке через Bitrix24 (3 попытки), INS использует резервный канал — SMTP (также 3 попытки).
   - Если оба канала недоступны, записывается ошибка в логи.

4. **Удаление обработанных уведомлений**:

   - После успешной отправки INS выполняет SQL-запрос на удаление уведомления из базы данных Firebird.

5. **Логирование**:
   - Все действия (успешные отправки, ошибки, удаления) логируются в InfluxDB для анализа и мониторинга.

---

## Особенности взаимодействия с базой данных Firebird

1. **Прямые запросы**:

   - Сервис уведомлений (INS) работает с базой данных Firebird напрямую через SQL-запросы. Это вызвано особенностями архитектуры и технологического стека ISPlanar.

2. **Типовые операции**:

   - **Чтение**: Получение списка неподтвержденных уведомлений.
   - **Удаление**: Удаление уведомлений после успешной отправки.

3. **Драйвер**:
   - Используется драйвер `node-firebird` для выполнения SQL-запросов к базе данных Firebird.

---

## Контейнеризация (Docker)

Сервис уведомлений (`isplanar-notification`) может быть запущен в контейнеризованной среде с использованием Docker. Это позволяет унифицировать процесс запуска, изолировать зависимости и использовать один и тот же образ как в development-, так и в production-среде.

### 1. Сборка образа

Образ строится на основе официального образа `node:23.x` и включает:

- Скомпилированный TypeScript код (`dist/`)
- Установленные зависимости (`node_modules`)
- Файлы конфигурации и переменных окружения (не включаются в сам образ, но подставляются при запуске)

Пример команды сборки:

```bash
docker build -t isplanar-notification .
```

### 2. Архитектура контейнера

Контейнер состоит из следующих компонентов:

- **Базовый образ**: `node:23.11.0`
- **Рабочая директория**: `/app`
- **Точка входа**: `npm run start` (для production)
- **Порты**: не публикуются напрямую, т.к. сервис не имеет HTTP-интерфейса
- **Переменные окружения**: передаются через файл `.env` при запуске
- **Монтирование**: не требуется в production, но используется в режиме разработки

### 3. Режимы запуска

#### Production-режим

В этом режиме запускается уже скомпилированное приложение (`dist/index.js`). Используются переменные окружения из `.env`.

```bash
docker run -d \
  --name isplanar-notification \
  --env-file .env \
  isplanar-notification
```

Также можно использовать готовый скрипт `run.sh`, который гарантирует чистый запуск.

#### Development-режим

Режим разработки позволяет монтировать исходный код внутрь контейнера и отслеживать изменения без пересборки образа. Используется `npm run dev` с автоматическим перезапуском.

```bash
docker run -it --rm \
  --name isplanar-notification-dev \
  --env-file ../.env.dev \
  -v $(pwd)/src:/app/src \
  -v $(pwd)/package.json:/app/package.json \
  -v $(pwd)/tsconfig.json:/app/tsconfig.json \
  -w /app \
  node:23.11.0 \
  npm run dev
```

### 4. Интеграция с системой

Контейнер взаимодействует со следующими внешними системами:

| Система           | Тип взаимодействия | Переменная окружения |
| ----------------- | ------------------ | -------------------- |
| Firebird          | SQL-запросы        | FIREBIRD\_\*         |
| Bitrix24 REST API | HTTP-запросы       | BITRIX\_\*           |
| SMTP-сервер       | Отправка email     | SMTP\_\*             |
| InfluxDB          | Логирование метрик | INFLUXDB\_\*         |

### 5. Управление контейнерами

Для управления жизненным циклом контейнера предусмотрены следующие скрипты:

| Скрипт       | Назначение                            |
| ------------ | ------------------------------------- |
| `build.sh`   | Сборка Docker-образа                  |
| `run.sh`     | Запуск контейнера в production-режиме |
| `stop.sh`    | Остановка и удаление контейнера       |
| `restart.sh` | Перезапуск контейнера                 |
| `logs.sh`    | Просмотр логов контейнера             |
| `status.sh`  | Запрос статуса работы контейнера      |
