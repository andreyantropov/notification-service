# Telemetry

–ù–∞–±–æ—Ä —É—Ç–∏–ª–∏—Ç —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏ –¥–ª—è –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:  
—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–∞—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ –∏ –º–µ—Ç—Ä–∏–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ **OpenTelemetry**.

> ‚ö†Ô∏è **–≠—Ç–æ—Ç –ø–∞–∫–µ—Ç –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç OpenTelemetry SDK.**  
> –û–Ω –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç **–∞–¥–∞–ø—Ç–µ—Ä—ã –ø–æ–≤–µ—Ä—Ö OpenTelemetry API**, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –≤ —Ö–æ—Å—Ç-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.

## üì¶ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ

### üìù –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- **`createLogger`** ‚Äî —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è `Logger` –∏–∑ `@notification-platform/shared`:
  - –≤—ã–≤–æ–¥ –≤ `stdout` —á–µ—Ä–µ–∑ `winston`,
  - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ—à–∏–±–æ–∫ (`serialize-error`),
  - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∏–º—ë–Ω –∏ –∞—Ç—Ä–∏–±—É—Ç–æ–≤ –≤ `snake_case`,
  - —ç–∫—Å–ø–æ—Ä—Ç –≤ OpenTelemetry Logs —á–µ—Ä–µ–∑ `@opentelemetry/winston-transport`,
  - —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: `traceId`, `spanId`, `service.name`, `level`, `timestamp`.

  –û–∂–∏–¥–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç –ª–æ–≥–∞:
  ```ts
  interface Log {
    readonly message: string;          // –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    readonly eventType?: EventType;    // —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–±—ã—Ç–∏–µ
    readonly durationMs?: number;      // –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
    readonly details?: unknown;        // –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    readonly error?: unknown;          // –æ—à–∏–±–∫–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å) ‚Äî –±—É–¥–µ—Ç —Å–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–∞
  }
  ```

### üîç –¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞
- **`createTracer`** ‚Äî —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è `Tracer` –∏–∑ `@notification-platform/shared`:
  - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∏–º—ë–Ω –∏ –∞—Ç—Ä–∏–±—É—Ç–æ–≤ –≤ `snake_case`,
  - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö –≤–∏–¥–æ–≤ span‚Äô–æ–≤ (`SERVER`, `CLIENT`, `PRODUCER` –∏ –¥—Ä.),
  - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–ø–∞–Ω–∞.

### üìä –ú–µ—Ç—Ä–∏–∫–∏
- **`createMeter`** ‚Äî —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è `Meter` –∏–∑ `@notification-platform/shared`:
  - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Å—á—ë—Ç—á–∏–∫–æ–≤ (`increment`) –∏ –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º (`record`),
  - –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ –ø–æ –∏–º–µ–Ω–∏ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è,
  - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –º–µ—Ç–æ–∫ (labels) –≤ `snake_case`.

## üß© –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- **OpenTelemetry SDK** –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –≤ —Ö–æ—Å—Ç-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä:

  ```ts
  import { diag, DiagConsoleLogger, DiagLogLevel } from '@opentelemetry/api';
  import { NodeSDK } from '@opentelemetry/sdk-node';

  diag.setLogger(new DiagConsoleLogger(), DiagLogLevel.ERROR);

  const sdk = new NodeSDK({ /* –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–µ—Ä–æ–≤, —Ä–µ—Å—É—Ä—Å–æ–≤ –∏ —Ç.–¥. */ });
  sdk.start();
  ```

- –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç **–ø—É–±–ª–∏—á–Ω—ã–π OpenTelemetry API** (`@opentelemetry/api`), –∞ –Ω–µ –ø—Ä—è–º—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ SDK.

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

```ts
// –í –≤–∞—à–µ–º —Å–µ—Ä–≤–∏—Å–µ
import { createLogger, createTracer, createMeter } from '@notification-platform/telemetry';
import type { Logger, Tracer, Meter } from '@notification-platform/shared';

const logger: Logger = createLogger();
const tracer: Tracer = createTracer({ serviceName: 'notification-service' });
const meter: Meter = createMeter({ serviceName: 'notification-service' });

// –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
logger.info({
  message: 'Notification sent',
  eventType: 'notification_sent',
  details: { channelId: 'email' },
});

// –¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞
await tracer.startActiveSpan('send_notification', { kind: 'PRODUCER' }, async (span) => {
  // ... –ª–æ–≥–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏
  span.end();
});

// –ú–µ—Ç—Ä–∏–∫–∏
meter.increment('notifications_processed_total', { channel: 'email' });
meter.record('channel_latency_ms', 150, { channel: 'email' });
```

## üìÅ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

- **–ó–∞–≤–∏—Å–∏—Ç –æ—Ç**:  
  `@notification-platform/shared` (–∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏ `Logger`, `Tracer`, `Meter`),  
  `@opentelemetry/api` (–ø—É–±–ª–∏—á–Ω—ã–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç),  
  `winston` + `@opentelemetry/winston-transport` (–ª–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏–µ),  
  `serialize-error`, `uuid` (–≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —É—Ç–∏–ª–∏—Ç—ã).
- **–ù–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç**:  
  –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ OpenTelemetry SDK –∏–ª–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ—Ä–æ–≤ ‚Äî –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ—Å—Ç–∞—ë—Ç—Å—è –∑–∞ —Ö–æ—Å—Ç-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º.

## üõ†Ô∏è –î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã

–ü–∞–∫–µ—Ç –≤–∫–ª—é—á–∞–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –Ω–∞–±–æ—Ä —Å–∫—Ä–∏–ø—Ç–æ–≤ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞:

- `build` ‚Äî –∫–æ–º–ø–∏–ª—è—Ü–∏—è TypeScript-–∫–æ–¥–∞ (`tsc`).  
- `test` ‚Äî –∑–∞–ø—É—Å–∫ unit-—Ç–µ—Å—Ç–æ–≤ –≤ watch-—Ä–µ–∂–∏–º–µ (`vitest`).  
- `test:coverage` ‚Äî –∑–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ —Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π –æ—Ç—á—ë—Ç–∞ –æ –ø–æ–∫—Ä—ã—Ç–∏–∏.  
- `lint` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ —Å –ø–æ–º–æ—â—å—é ESLint.  
- `lint:fix` ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–∏–Ω—Ç–∏–Ω–≥–æ–≤—ã—Ö –æ—à–∏–±–æ–∫.  
- `lint:format` ‚Äî —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ —Å –ø–æ–º–æ—â—å—é Prettier.  
- `typecheck` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤ –±–µ–∑ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤—ã—Ö–æ–¥–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ (`tsc --noEmit`).  

–≠—Ç–∏ —Å–∫—Ä–∏–ø—Ç—ã –ø–æ–º–æ–≥–∞—é—Ç –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å, –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å –∏ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å –æ—Å—Ç–∞–ª—å–Ω—ã–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã, –æ—Å–æ–±–µ–Ω–Ω–æ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–µ—Ä–≤–∏—Å–∞—Ö.